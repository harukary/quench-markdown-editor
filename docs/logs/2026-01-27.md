# 2026-01-27

## 目的 / 背景
- Quench Settings で保存した設定（特に Theme の Accent / Cursor）が、エディタ表示へ反映されないという報告の調査・修正。

## 症状
- Quench Settings の保存自体は成功する（`globalStorage` 配下の `quench-settings.json` が更新される）。
- しかし見た目（見出し色など）が変わらず、「設定が反映されない」ように見える。

## 重要な制約
- その場しのぎのフォールバックや例外握りつぶしは行わず、優先順位を明確化して原因を露呈させる方針。

## 原因（推定ではなく確認ベース）
- Webview に注入される CSS は `#quench-user-css` 内で「後勝ち」になる。
- 既存実装では `quench.css.files`（ワークスペースCSS）を **後** に注入していたため、ワークスペース側の `.vscode/quench-theme.css` が `--quench-accent` 等を上書きし、Quench Settings の Theme 変更が見えなくなる。

## 実施内容
- `src/extension/QuenchEditorProvider.ts` の CSS 注入順序を変更し、Theme のグローバル上書きを `quench.css.files` の後に適用するように修正。
- Quench 起動直後にグローバル設定読み込みが遅延しても、すでに開いている Webview に反映されるよう、読み込み完了後に CSS/設定の再配信を追加。
- Quench Settings UI に、Theme の優先順位（`quench.css.files` の後に適用）を明示する文言を追加。

## 実行したコマンド
- `npm run build`
- `npm run compile`

## 動作確認結果
- 実行したこと:
  - TypeScript コンパイル（`tsc -p .`）が成功すること。
- 未実施:
  - VS Code 上での実機確認（設定保存→見出し色/カーソル色の即時反映）。

## 既知のノイズ / 未解決 / 次のTODO
- ワークスペースごとに Theme を分けたい場合、グローバル Theme 上書きが強く働くため、運用方針の整理が必要（例: グローバルは空にして `.vscode/quench-theme.css` を使う、など）。

