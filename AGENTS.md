# AGENTS.md（quench-markdown-editor）

## 言語

- 返答は常に日本語で行うこと。

## クリーンな挙動とフォールバック抑制ポリシー

「とりあえず動かすための場当たり的なフォールバック」や、「局所的・ごまかし的なヒューリスティック」を抑制し、あとから検証・変更しやすい状態を維持することを目的とします。

### 基本原則

- 「その場しのぎで安全そうに見せる」よりも、「問題や不明点を正しく露呈させる」ことを優先する。
- 仕様・設計・企画に明示されていない挙動を、「良さそうだから」という理由だけで勝手に追加しない。
- 「とりあえず動く」ことより、
  - なぜそうなっているか説明できること
  - 検証・テスト・デバッグがしやすいこと  
    を優先する。

### 禁止されるフォールバック・ヒューリスティック

- 無断フォールバックの禁止
  - 本来のロジックが失敗したとき、ユーザーや開発者に分からない形で別ロジックにフォールバックする実装を勝手に追加してはならない。
  - 特定パスだけ「それっぽい値」を返す隠れたフォールバックを入れてはならない。
- 例外握りつぶしの禁止
  - 広すぎる例外を `try/except` や `try/catch` で握りつぶし、ログも出さずにデフォルト値や空配列などを返す実装をしてはならない。
  - エラーを「なかったこと」にして、成功したかのように見せてはならない。
- 暗黙のデフォルト値によるごまかしの禁止
  - 本来ありえない状態で 0・空文字・空配列などを返し、そのまま処理を継続するような実装を避ける。
  - 仕様に定義されていない「適当なデフォルト値」を勝手に決めてはならない。
- サイレントリトライ・サイレントスキップの禁止
  - API や DB アクセスに失敗したとき、失敗を記録せずに何度もリトライしたり、該当データを黙ってスキップして処理を続ける実装を禁止する。
  - 失敗した事実がログや計測から追えなくなるようなフォールバックは禁止する。

### エラー・不明点への正しい対応

- エラーは正直に露呈させる
  - エラーが起きたら、握りつぶさず、ログや例外として見える形で表現する。
  - エラー処理方針が判断できない場合、「要判断」であることをコメントやメモで明示し、暫定処理を独断で確定させない。
- 不明な仕様や前提条件を埋めない
  - 戻り値の型・DB スキーマ・API 仕様などが不明なとき、推測で実装を確定させない。
  - 推定に基づく実装を提案する場合は、「ここは推定」「ここは TODO」と明記する。
- 実行したことと想像を分ける
  - 実際には実行していないテストや確認を、実行したかのように書いてはならない。
  - コード例やテストケースは、あくまで「提案」であり、実行結果であるかのように装ってはならない。

### 個別最適なヒューリスティックの扱い

- 特定ケース専用のマジックナンバー・条件の乱立禁止
  - 個別案件や一時的事情だけを満たすマジックナンバーや if 条件を、安易に追加してはならない。
  - そのヒューリスティックが他ケースに与える影響が不明な場合、「危険な応急処置」であると認識し、必ずコメントでリスクを明示する。
- 局所最適より全体整合性を優先
  - 特定入力だけを「きれいに見せる」ために、仕様全体やデータモデルの一貫性を壊す実装を避ける。
  - UX・仕様・データの整合性を、バグ隠しのロジックより優先する。
- ヒューリスティックの前提を明示
  - やむを得ずヒューリスティックを導入する場合は、その前提・意図・適用範囲・危険性をコメントやドキュメントで説明する。
  - 「なんとなくこのほうが良さそう」という曖昧な理由だけで実装してはならない。

### 自己チェックの問い

重要なロジック追加や変更のたびに、次の問いを自問自答した前提で振る舞うこと。

- 「この挙動は、本当に仕様・設計・企画に沿っているか？」
- 「この変更は、エラーやバグ、不整合を隠していないか？」
- 「この実装は、テストや検証、障害調査を難しくしていないか？」
- 「とりあえず動かすためだけの安易なフォールバックやヒューリスティックを選んでいないか？」
- 「ここはあえてエラーのままにしておいた方が、長期的には健全ではないか？」
  これらの問いに対する答えが曖昧な場合は、「その場しのぎで安全そうに見せる」方向ではなく、「問題を露呈させ、あとから修正しやすい形にとどめる」方向を選ぶこと。

## 開発記録運用（`docs/logs/`）

- 1セッション（または1トピック）ごとに `docs/logs/` に開発ログを残す。
- ファイル名は原則 `YYYY-MM-DD.md`。同日に複数ある場合は `YYYY-MM-DD_2.md` などで連番にする。
- ログに含める推奨項目:
  - 目的 / 背景
  - 症状（ログ・スクショ・再現手順）
  - 重要な制約（例: version固定、CSP制約、Decoration制約など）
  - 実施内容（変更点の要約、設計判断の理由）
  - 実行したコマンド（ビルド/パッケージ/インストール等）
  - 動作確認結果（「実行したこと」と「未実施」を明確に分ける）
  - 既知のノイズ/未解決/次のTODO
- **秘密情報・トークン・個人情報は書かない**（パスは必要最小限、外部URLは慎重に）。

## バックグラウンド実行メモ

- 長時間かかる処理（例: CR ZIP 1000件超の展開、大容量PDF変換、全DOCXバッチ処理など）は `nohup ... &` でバックグラウンドに回し、標準出力をログにリダイレクトする。例:
  - `nohup bash xxx.sh -f > dev/tmp/archive/extract_ran5_zips_103.log 2>&1 &`
- バックグラウンド実行が必要になる目安:
  - 推定実行時間が数分以上で、ターミナル占有が業務を阻害するケース
  - 入力ファイル数やサイズが非常に多い場合（数百件～）
  - ロングラン処理中に他作業を平行したい場合（ログを tail しながら状況監視）
- 実行後は `tail -f <log>` や `ps -p <PID>` で進捗を確認し、完了したらログを保存しておく。

## Git / コミット運用（重要）

- コミット前に作業ツリーに「関連しない変更」が混在していても、**ユーザーの明示指示なしに勝手に削除（checkout/reset）しない**。
- 取るべき対応は「削除」ではなく、次のいずれかをユーザーに確認して選ぶこと:
  - そのまま同一コミットに含める
  - 変更を残したまま、関連分だけを `git add -p` 等で選んで別コミットに分ける
  - 別ブランチ/別コミットに退避してから進める
