# 2026-01-28

## 目的 / 背景
- カーソル色の上書きが効かず黒く見える問題の切り分けと修正。
- Live Preview の太字/斜体が効かない、または全体が太字っぽく見える問題の修正。
- 変更履歴を `CHANGELOG.md` で管理しつつリリース。

## 症状
- 設定上 `--quench-cursor` が `#ffffff` でも、カーソルが黒く見える。
- `**bold**` で見た目が変わらない、または全体が太字に見える。

## 実施内容
- カーソル色: `caret-color` をより強い優先度で上書きするよう修正（`!important`）。
- 太字/斜体: `md-bold` / `md-italic` のCSSを追加し、ベースの `font-weight` を `normal` に固定して意図しない太字化を抑制。
- デバッグ用に一時追加した `Quench: Debug Cursor` は削除。
- `CHANGELOG.md` を更新（最新を先頭）。
- テーブル表示確認用に `docs/table-samples.md` を追加。

## 実行したコマンド
- `npm run build`
- `npx --yes @vscode/vsce package`
- `code --install-extension ./quench-markdown-editor-*.vsix --force`

## 動作確認結果
- 実行したこと:
  - ローカルVSIXインストール後、カーソルが白く見えることを確認（ユーザー報告）。
- 未実施:
  - OS/テーマ差分（light/high-contrast 等）での網羅確認。

## 既知のノイズ / 未解決 / 次のTODO
- Marketplace公開前に、コミット運用（タグ/リリース手順）を整理する余地あり。

---

## 追加トピック: テーブル上下余白が大きい問題

### 症状
- Live Preview のテーブル表示で、表の上下の空白が大きく見える。

### 実施内容
- テーブル表示を「ブロックウィジェット挿入＋テーブル行を高さ0で潰す」方式に変更し、テーブル行数分の縦スペースが残る問題を解消する方針に切り替え。
  - `src/webview/main.ts`: `Decoration.widget({ block: true })` で表を挿入し、元のテーブル各行は `Decoration.replace` + `Decoration.line({ class: "md-table-hidden-line" })` で非表示/圧縮。
  - `media/base.css`: `.cm-line.md-table-hidden-line` を追加し、行高さ/余白を 0 に固定。
- テーブルクリックで編集モードに入る処理は維持（クリック時に caret をテーブル内へ移動）。

### 実行したコマンド
- `npm run build`

---

## 追加トピック: v0.0.11 を Marketplace に Publish

### 実施内容
- `package.json` のバージョンを `0.0.11` に更新。
- `CHANGELOG.md` に `0.0.11` の修正内容を追記。
- `npx vsce publish` で Marketplace に公開。

### 実行したコマンド
- `npm run build`
- `npx vsce package -o quench-markdown-editor-0.0.11.vsix`
- `npx vsce publish`

### 結果
- `harukary7518.quench-markdown-editor v0.0.11` を公開。
- `npx vsce package -o quench-markdown-editor-0.0.8-local.vsix`

### 動作確認結果
- 実行したこと:
  - ビルドと VSIX パッケージ生成が成功することを確認。
- 未実施:
  - VS Code 上での見た目（上下余白が期待通り詰まるか）確認。

---

## 追加トピック: Ctrl/⌘+Hover のリンク強調が効かない

### 症状
- Ctrl/⌘ を押しながらリンクにホバーしても、水色（強調色）＋下線の強調が効かない。

### 原因
- Webview 環境によっては「修飾キー単体の keydown/keyup」が安定して発火せず、`body.quench-mod` が切り替わらないケースがある。

### 実施内容
- `src/webview/main.ts`: `mousemove` / `click` の `MouseEvent.ctrlKey/metaKey` をソースオブトゥルースとして `body.quench-mod` を同期するよう修正。
- `src/webview/main.ts`: プレーンURL/パスはトークンハイライト任せだとclassが付かない場合があるため、Ctrl/⌘押下中にホバーしているリンク範囲へ一時的な `Decoration.mark("quench-mod-hover")` を適用。
- `media/base.css`: `.cm-content .quench-mod-hover` の色/下線スタイルを追加。

### 実行したコマンド
- `npm run build`
- `npx vsce package -o quench-markdown-editor-0.0.8-local.vsix`
- `code --install-extension ./quench-markdown-editor-0.0.8-local.vsix --force`

---

## 追加トピック: Ctrl+D / Ctrl+Shift+L の複数選択ができない

### 症状
- Quenchエディタ上で、VS Code標準の `Ctrl+D`（次の一致を選択）や `Ctrl+Shift+L`（一致をすべて選択）が動かない。

### 原因
- Webview内のCodeMirror側に該当ショートカットのkeymapが未実装。

### 実施内容
- `src/webview/main.ts` に CodeMirror の keymap を追加し、`Mod-d` / `Shift-Mod-l` を実装。
  - `Mod-d`: 現在選択の次の一致を追加（未選択なら単語選択）。
  - `Shift-Mod-l`: 現在選択の全一致を複数選択（未選択なら単語選択→全一致）。

### 実行したコマンド
- `npm run build`
- `npx vsce package -o quench-markdown-editor-0.0.9-local.vsix`
- `code --install-extension ./quench-markdown-editor-0.0.9-local.vsix --force`

---

## 追加トピック: VS Codeの手癖に合わせた移動/チェックボックス（Cmd+L）

### 実施内容
- `src/webview/main.ts` に keymap を追加し、以下を Quench 側で処理するように変更。
  - `Cmd+←/→` と `Shift+Cmd+←/→`: 単語単位の移動/選択（あなたの `keybindings.json` に合わせる）
  - `Alt+←/→` と `Shift+Alt+←/→`: 行頭/行末への移動/選択（あなたの `keybindings.json` に合わせる）
  - `Cmd+L`: チェックボックス行のトグル（Obsidian寄せ）

### 実行したコマンド
- `npm run build`
- `npx vsce package -o quench-markdown-editor-0.0.9-local.vsix`
- `code --install-extension ./quench-markdown-editor-0.0.9-local.vsix --force`

---

## 追加トピック: Markdown整形ショートカット（Cmd+1..6 / Cmd+'）

### 実施内容
- `src/webview/main.ts` に keymap を追加し、あなたの `keybindings.json` に合わせて以下をQuench側で実装。
  - `Cmd+1..6`: 見出しレベルのトグル（同レベルなら解除、別レベルならそのレベルへ変更）
  - `Cmd+'`: 箇条書きのトグル（`- ` を付与/解除）
  - `Shift+Cmd+'`: チェックボックスのトグル（`Cmd+L` と同等）

### 実行したコマンド
- `npm run build`
- `npx vsce package -o quench-markdown-editor-0.0.9-local.vsix`
- `code --install-extension ./quench-markdown-editor-0.0.9-local.vsix --force`

---

## 追加トピック: Quench Settings からショートカット編集

### 目的
- CSSと同様に、Quenchのショートカット（webview内CodeMirrorのkeymap）を Settings UI から編集・保存できるようにする。

### 実施内容
- `src/shared/protocol.ts`: `QuenchSettings.keybindings?: Record<string, string[]>` を追加。
- `src/extension/services/GlobalSettingsService.ts`: `overrides.keybindings` の保存/検証を追加（値は `string[]` のみ許容。空配列は「無効化」）。
- `src/extension/QuenchEditorProvider.ts`: Settings UI に Keybindings セクションを追加（Disableチェック付き）。
- `src/webview/main.ts`: `keybindingsCompartment` を導入し、`SETTINGS_UPDATED` でkeymapを動的に差し替え。

### 実行したコマンド
- `npm run build`
- `npx vsce package -o quench-markdown-editor-0.0.9-local.vsix`
- `code --install-extension ./quench-markdown-editor-0.0.9-local.vsix --force`

### 追記: キー入力での登録
- Settings UI の Keybindings 入力欄で、実際に押したキー（Cmd/Ctrl/Shift/Alt + 任意キー）から CodeMirror 形式（例: `Mod-l`, `Shift-Mod-ArrowLeft`）を自動入力できるようにした。
- 修飾なしの単文字入力は手入力の妨げになるためキャプチャしない（例外: 矢印キー等の特殊キー）。

---

## 追加トピック: Webview boot error（Block decorations may not be specified via plugins）

### 症状
- VS Code のログで `Quench: Webview boot error: Block decorations may not be specified via plugins` が出て、カスタムエディタが起動失敗するケースがあった。

### 実施内容
- `src/webview/main.ts` の live preview の装飾適用を `ViewPlugin` から `EditorView.decorations.of(...)` に移し、CodeMirror の制約（block decoration と plugin の組み合わせ）に引っかかりにくい構造に変更。
- `forceRedrawEffect` 用に `forceRedrawField` を追加し、画像解決等で `view.dispatch({ effects: forceRedrawEffect... })` したときに装飾が確実に再評価されるようにした。
- live preview の装飾生成で例外が出た場合、Webview を落とさずに `Decoration.none` を返すように変更（バナー表示 + `BOOT_ERROR` 送信は維持）。

### 実行したコマンド
- `npm run build`
