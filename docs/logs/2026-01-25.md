---
date: 2026-01-25
project: quench-markdown-editor
version: 0.0.1
---

# 開発ログ（2026-01-25）

## 目的
- VS Code の Custom Editor「Quench」で `Reopen With…` しようとしても開かない問題を解消し、安定して表示できる状態にする
- Obsidian の Live Preview 風の見た目・編集体験（装飾/カーソル/コード/テーブル等）を追加する
- テーマCSSを `.vscode/` 配下で運用できるようにし、必要なら自動生成する

## 重要な前提・制約
- 拡張のバージョンは **`0.0.1` 固定**（version bump しない方針）
- 「場当たり的なフォールバック」は避け、エラーは握りつぶさずに露呈（Webview 側 `BOOT_ERROR` など）

## 発生していた主な症状（抜粋）
- `Reopen with Quench` で開けず、`Webview の起動待ち: timeout` などで失敗
- Extension Host ログで `Cannot find module 'markdown-it'`（VSIXに依存が入っていない）
- Webview 側で `An instance of the VS Code API has already been acquired`（`acquireVsCodeApi()` 二重呼び）
- CodeMirror の Decoration 制約に抵触して Webview が落ちる
  - `Mark decorations may not be empty`
  - `Block decorations may not be specified via plugins`
  - `Decorations that replace line breaks may not be specified via plugins`

## 実施内容（要点）

### 1) 起動・パッケージングの安定化
- VSIX作成時に依存が落ちて `markdown-it` が解決できない問題に対応
  - 依存込みでパッケージする前提に変更（`vsce package` 実行時の同梱内容を確認）
- Webview の初期化順序/ハンドシェイクを調整し、`WEBVIEW_READY` 待ちタイムアウトを回避
- CSP/nonce を整備し、読み込みの安定性を向上
- `acquireVsCodeApi()` の二重取得を避けるため、`window.__quench_vscode` にキャッシュする方式に変更

### 2) Live Preview（Obsidian-ish）装飾の追加/調整
- 見出し（ATX/Setext）: 紫系アクセント、`##` 等のシンタックスは薄く、本文は `md-heading`
- 箇条書き: `-/*/+` をドット表示に置換（選択中は元記号を残す）
- インラインコード: バッククォートは非表示（選択中のみ表示）、本文に `md-inline-code`
- フェンスコードブロック:
  - 背景グレー
  - 言語（```lang）をピル表示（グレー枠内）
  - 「npm の左に謎の丸」など余計な欠片を出さないようCSS調整
- 水平線: `---/***/___` をライン表示
- タスクチェックボックス: クリックで `[ ]` / `[x]` をトグルして実テキストを書き換える
- 引用内でも装飾を適用（`>` プレフィックスを考慮してオフセット補正）
- テーブル: 置換/ブロック装飾で落ちるのを避け、行装飾（`Decoration.line`）で枠/ヘッダ/ゼブラ等を表現

### 3) テーマ/可読性の改善
- ダークテーマで「青いリンク/暗すぎる文字」が見づらい問題に対処
  - `--quench-link` / `--quench-muted` などを調整
  - CodeMirror のトークン色（青寄り）を抑え、読みやすい配色に寄せる
- カーソルが見えない問題に対処（`caret-color` / `.cm-cursor` を `--quench-cursor` に追従）

### 4) テーマCSS運用（`.vscode/`）
- `Quench: Create Theme CSS (Workspace)` を追加し、`.vscode/quench-theme.css` を生成
- コマンド無しでも使えるよう、Custom Editor 起動時にテーマCSSが無ければ自動生成するフローを追加
- 設定スコープ問題（`Folder Settings に書けない`）に対応
  - `quench.css.files` 等の設定を `resource` スコープに見直し（フォルダ/ワークスペース単位で扱えるように）

### 5) サンプルの整備（別リポジトリ）
- `/Users/inoueryo/workspace/sample/docs/quench-all-elements.md` を作成（全要素確認用）
- `sample/docs/images/sample.png` を生成し、画像プレビューの参照先が「実在する」状態にした

## 最終的に効いた修正（見出し下線の残存）
- 見出しの `## ` 側に下線が残るケースがあり、トークンクラス（`cm-*` / `tok-*`）を潰しても取り切れない場面があった
- 対策として **見出し行全体に `Decoration.line` で `md-heading-line` を付与**し、
  - `.cm-line.md-heading-line, .cm-line.md-heading-line * { text-decoration: none !important; }`
  を適用して「見出し行の下線を確実に無効化」

## 実行したコマンド（主要）
- `npm run build`
- `npx vsce package -o quench-markdown-editor-0.0.1.vsix`
- `code --install-extension ./quench-markdown-editor-0.0.1.vsix --force`

## 既知のノイズ/注意点
- `https://marketplace.visualstudio.com/_apis/public/gallery/vscode/inoueryo/quench-markdown-editor/latest 404`
  - Marketplace 未公開のため VS Code の更新確認が 404 になる。機能不具合ではない。

## 次のTODO候補
- コードブロックのシンタックスハイライトを言語ごとに強化（必要な言語の追加/最適化）
- テーブルの見た目をさらにObsidian寄せ（罫線/セルpadding/アライメントの改善）
- 引用内コードブロック（`> ```lang`）の対応方針を決める（現状は行頭限定）
