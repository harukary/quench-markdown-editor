# 2026-01-30

## 目的 / 背景
- Markdown の既定エディタを Quench にしつつ、Git の差分表示（Diff ビュー）で開くときは Text Editor（通常のテキスト/差分エディタ）を使いたい。

## 症状
- Source Control（Git）の差分から `*.md` を開いた際に、Quench の Custom Editor が適用され、Diff ビューでの閲覧がしにくい。

## 実施内容
- 当初案: `contributes.customEditors.selector` に `scheme` を明示して Quench の適用範囲を絞る。
  - ただし、この方針だと Git の差分表示（比較ビュー）自体が崩れる可能性があり、採用しない。
- 採用案: VS Code の `workbench.editorAssociations` を明示設定し、`git` / `gitlens` スキームの `.md` は常に `default`（Text Editor）で開く。
  - 変更を自動化するため、コマンド `Quench: Use Text Editor in Git Diff for Markdown` を追加。
- 追加: `vscode.diff`（テキスト差分）で必ず開くコマンド `Quench: Open Git Diff (Text Editor)` を追加。
  - SCM のコンテキストメニュー（右クリック）から `.md` で実行できるようにする。
  - `workbench.editorAssociations` のキーを `git:/**/*.md` / `gitlens:/**/*.md` に修正（`{git,gitlens}:...` は無効だった）。
- `activationEvents` に `onCommand:quench.configureGitDiffTextEditor` / `onCommand:quench.openGitDiffInTextEditor` を追加（コマンド起動で拡張が確実に activate されるようにする）。
- README に Git Diff 時の使い分け手順（設定/コマンド/制約）を追記。
- 代替案として「Markdown の既定は Text Editor のままにして、エディタ上部（editor/title）から Quench を開く」導線を追加。
  - コマンド: `Quench: Open in Quench`（editor/title ではアイコン表示）
  - `editor/title` メニューに `.md` かつ非Diffの場合に表示
  - `vscode.openWith` が新規タブで開く場合があるため、挙動を「開き直し（既存のTextタブを閉じる）」に変更。
    - 未保存（dirty）の場合は誤って閉じないようエラーで中断する（保存後に再実行）。
  - `Tab close: Invalid tab not found!` が出るケースがあり、タブを閉じるタイミングを `openWith` の「後」→「前」に変更（Tabオブジェクト無効化を回避）。

## 変更ファイル
- `package.json`
- `src/extension.ts`
- `src/extension/QuenchEditorProvider.ts`
- `README.md`

## 実行したコマンド
- `npm run build`
- `npx vsce package -o quench-markdown-editor-0.0.12-local.vsix`
- `code --install-extension quench-markdown-editor-0.0.12-local.vsix --force`
- `npm run build`（README/activationEvents 追記後に再実行）
- `npx vsce package -o quench-markdown-editor-0.0.12-local2.vsix`
- `code --install-extension quench-markdown-editor-0.0.12-local2.vsix --force`
  - `vsce package` の警告: `repository` 欄なし / LICENSE ファイルなし（現状のまま）
- `npm run build`（editor/title ボタン追加後に再実行）
- `npx vsce package -o quench-markdown-editor-0.0.12-local3.vsix`
- `code --install-extension quench-markdown-editor-0.0.12-local3.vsix --force`
- `npm run build`（editor/title のコマンドをアイコン表示に変更後に再実行）
- `npx vsce package -o quench-markdown-editor-0.0.12-local4.vsix`
- `code --install-extension quench-markdown-editor-0.0.12-local4.vsix --force`
- `npm run build`（openWith を「開き直し」動作に変更後に再実行）
- `npx vsce package -o quench-markdown-editor-0.0.12-local5.vsix`
- `code --install-extension quench-markdown-editor-0.0.12-local5.vsix --force`
- `npm run build`（Tab close エラー修正後に再実行）
- `npx vsce package -o quench-markdown-editor-0.0.12-local6.vsix`
- `code --install-extension quench-markdown-editor-0.0.12-local6.vsix --force`

## 動作確認
- 未実施（要: コマンド実行後、Source Control の差分から `.md` を開いて比較ビューになることを確認）

## TODO
- README 追記は実施済み。残タスクは「実機での再現確認（SCM から `.md` を開いて比較ビューになる）」。
